<% include( 'elements/search.html',
                 'title'       => $title,
                 'name'        => 'credits',
                 'query'       => $sql_query,
                 'count_query' => $count_query,
                 'count_addl'  => \@count_addl,
                 #'redirect'    => $link,
                 'header'      => \@header,
                 'fields'      => \@fields,
                 'align' => $align,
                 'links' => \@links,
                 'color' => \@color,
                 'style' => \@style,
      )
%>
<%init>

die "access denied"
  unless $FS::CurrentUser::CurrentUser->access_right('Financial reports');

my $money_char = FS::Conf->new->config('money_char') || '$';

my $title = 'Credit Search Results';
#my( $count_query, $sql_query );

my $unapplied = $cgi->param('unapplied');
$title = "Unapplied $title" if $unapplied;
my $clink = sub {
  my $cust_bill = shift;
  $cust_bill->cust_main_custnum
    ? [ "${p}view/cust_main.cgi?", 'custnum' ]
    : '';
};

my (@header, @fields, $align, @links, @color, @style);
$align = '';

#amount
push @header, 'Amount';
push @fields, sub { $money_char .sprintf('%.2f', shift->amount) };
$align .= 'r';
push @links, '';
push @color, '';
push @style, '';

# unapplied amount
if ($unapplied) {
  push @header, 'Unapplied';
  push @fields, sub { $money_char .sprintf('%.2f', shift->unapplied_amount) };
  $align .= 'r';
  push @links, '';
  push @color, '';
  push @style, '';
}

push @header, 'Date', 
              'By',
              'Reason',
              FS::UI::Web::cust_header(),
              ;
push @fields, sub { time2str('%b %d %Y', shift->_date ) },
              'otaker',
              'reason',
              \&FS::UI::Web::cust_fields,
              ;
$align .= 'rll'.FS::UI::Web::cust_aligns(),
push @links,  '',
              '',
              '',
              ( map { $_ ne 'Cust. Status' ? $clink : '' }
                         FS::UI::Web::cust_header()
                   ),
              ;
push @color,  '',
              '',
              '',
              FS::UI::Web::cust_colors(),
              ;
push @style,  '',
              '',
              '',
              FS::UI::Web::cust_styles(),
              ;

my @search = ();

if ( $cgi->param('usernum') =~ /^(\d+)$/ ) {
  push @search, "cust_credit.usernum = $1";
}

if ( $cgi->param('agentnum') && $cgi->param('agentnum') =~ /^(\d+)$/ ) {
  push @search, "agentnum = $1";
  my $agent = qsearchs('agent', { 'agentnum' => $1 } );
  die "unknown agentnum $1" unless $agent;
  $title = $agent->agent. " $title";
}

if ( $unapplied ) {
  push @search, FS::cust_credit->unapplied_sql . ' > 0';
}

my($beginning, $ending) = FS::UI::Web::parse_beginning_ending($cgi);
push @search, "_date >= $beginning ",
              "_date <= $ending";

push @search, FS::UI::Web::parse_lt_gt($cgi, 'amount' );

#here is the agent virtualization
push @search, $FS::CurrentUser::CurrentUser->agentnums_sql;

my @select = (
    'cust_credit.*',
    'cust_main.custnum as cust_main_custnum',
    FS::UI::Web::cust_sql_fields(),
);

if ( $unapplied ) {
  push @select, '('.FS::cust_credit->unapplied_sql .') AS unapplied_amount';
  push @search, FS::cust_credit->unapplied_sql .' > 0';
}

my $where = 'WHERE '. join(' AND ', @search);

my $count_query = 'SELECT COUNT(*), SUM(amount) ';
$count_query .= ', SUM(' . FS::cust_credit->unapplied_sql . ') ' if $unapplied;
$count_query .= 'FROM cust_credit LEFT JOIN cust_main USING ( custnum ) '.
                  $where;

my @count_addl = ( $money_char.'%.2f total credited (gross)' );
push @count_addl, $money_char.'%.2f unapplied' if $unapplied;

my $sql_query   = {
  'table'     => 'cust_credit',
  'select'    => join(', ',@select),
  'hashref'   => {},
  'extra_sql' => $where,
  'addl_from' => 'LEFT JOIN cust_main USING ( custnum )',
};

</%init>

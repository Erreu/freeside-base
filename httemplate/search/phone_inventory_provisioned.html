<% include( 'elements/search.html',
              'title'         => 'LATA Search Results',
              'name_singular' => 'LATA',
              'query'         => {
                                   'table'   => 'phone_avail',
                                   'hashref' => {},
                                   'select'  => 'distinct latanum',
                                 },
              'count_query'   => 'SELECT COUNT(distinct latanum) FROM phone_avail',
              'header'        => [ 'LATA',
				   'Available',
				   'Provisioned',
				   'Have Usage',
                                 ],
              'fields'        => [
        sub { # LATA
            my $did_order = shift;
            my $lata = $did_order->lata;
            $lata = $lata ? $lata->description : '';
            $did_order->latanum . " - " . $lata;
        },
		sub { # Available
		    my $latanum = shift->latanum;
		    my @dids = qsearch('phone_avail',
                                    { 'svcnum' => '',
                                      'latanum' => $latanum,
                                    }
                          );
		    return scalar(@dids);
		},
		sub { # Provisioned
		    my $latanum = shift->latanum;
		    my @dids = provisioned_dids($latanum);
		    return scalar(@dids);
		},
		sub { # Have Usage
		    my $latanum = shift->latanum;
		    my @dids = provisioned_dids($latanum);

            warn "have usage ".time;
            return ''; # XXX disabled temporarily

		    my $count = 0;
		    foreach my $did ( @dids ) {
                next unless $did->cust_svc;
                my $svc_phone = $did->cust_svc->svc_x;
                warn "inside loop ".time;
                next unless $svc_phone;
                my @cdrs = $svc_phone->get_cdrs;
                $count++ if scalar(@cdrs);
		    }
		    $count;
		},
              ],
              'align'         => 'lccc',
              'links'         => [
                '',
		'',
		'',
		'',
              ],
              'color' => [ 
                           '',
			   '',
			   '',
			   '',
                         ],
              'style' => [ 
                           '',
			   '',
			   '',
			   '',
                         ],
      )
%>
<%init>

warn "started @ ".time;

die "access denied"
  unless ( $FS::CurrentUser::CurrentUser->access_right('List inventory')
	 && $FS::CurrentUser::CurrentUser->access_right('List services')
	 );

# XXX: agent virtualize

sub provisioned_dids {
    my $latanum = shift;
    qsearch({   'table' => 'phone_avail',
	            'hashref' => { 'latanum' => $latanum, },
	            'extra_sql' => ' and svcnum is not null ',
	        });
}

</%init>

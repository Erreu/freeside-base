<% include( 'elements/search.html',
              'title'         => 'LATA Search Results',
              'name_singular' => 'LATA',
              'query'         => {
                                   'table'   => 'phone_avail',
                                   'hashref' => {},
                                   'select'  => 'distinct latanum',
                                 },
              'count_query'   => 'SELECT COUNT(distinct latanum) FROM phone_avail',
              'header'        => [ 'LATA',
				   'Available',
				   'Provisioned',
				   'Have Usage',
                                 ],
              'fields'        => [
        sub { # LATA
            my $phone_avail = shift;
            my $lata = $phone_avail->lata;
            $lata = $lata ? $lata->description : '';
            $phone_avail->latanum . " - " . $lata;
        },
		sub { # Available
		    my $latanum = shift->latanum;
		    my $cnt = qsearchs({ 'table'    => 'phone_avail',
                                 'hashref'  => 
                                    { 'svcnum' => '',
                                      'latanum' => $latanum,
                                    },
                                 'select'   => 'count(1) as cnt',
                          });
		    ($cnt) ? $cnt->cnt : '';
		},
		sub { # Provisioned
		    my $latanum = shift->latanum;
            my $cnt = qsearchs({   'table'     => 'phone_avail',
                        'hashref'   => { 'latanum' => $latanum,
                                         'svcnum' => { op => '>',
                                                        value => '0'
                                                     },
                                        },
                        'select'    => 'count(1) as cnt'
                    });
		    ($cnt) ? $cnt->cnt : '';
		},
		sub { # Have Usage
            my $phone_avail = shift;
            return '' unless $phone_avail->latanum;
            my $latanum = $phone_avail->latanum;
		    my $count = 0;
            my $sql = "select count(1) from cdr where src in 
                (select phonenum from svc_phone where svcnum in (
                    select svcnum from phone_avail where latanum = $latanum
                        and svcnum is not null) )
                or charged_party in (select phonenum from svc_phone where
                    svcnum in (select svcnum from phone_avail where
                        latanum = $latanum and svcnum is not null) )";
            my $c = $phone_avail->scalar_sql($sql);
            $count++ if $c > 0;
		    $count;
		},
              ],
              'align'         => 'lccc',
              'links'         => [
                '',
                '',
                '',
                '',
              ],
              'color' => [ 
                           '',
                           '',
                           '',
                           '',
                         ],
              'style' => [ 
                           '',
                           '',
                           '',
                           '',
                         ],
      )
%>
<%init>

die "access denied"
  unless ( $FS::CurrentUser::CurrentUser->access_right('List inventory')
	 && $FS::CurrentUser::CurrentUser->access_right('List services')
	 );

# XXX: agent virtualize

</%init>

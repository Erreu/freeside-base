<% include('/elements/header-popup.html', $success_msg ) %>
  <SCRIPT TYPE="text/javascript">
    <% $js %>
  </SCRIPT>
  </BODY>
</HTML>
<%init>
die "access denied"
  unless $FS::CurrentUser::CurrentUser->access_right('Import');

$cgi->param('action') =~ /^(confirm|cancel|provision)$/ or die 'illegal action';
my $action = $1;
my $success_msg = '';
my $error = '';
my $js = 'window.top.location.reload();';

$cgi->param('ordernum') =~ /^(\d+)$/ or die 'illegal ordernum';
my $ordernum = $1;
my $did_order = qsearchs( {
  'table'     => 'did_order',
  'hashref'   => { 'ordernum' => $ordernum },
} );
die "No order $ordernum" unless $did_order;

if ( $action eq 'confirm' ) {
    my $confirmed = '';
    my $sucess_msg = 'DID order confirmed';
    $confirmed = parse_datetime($cgi->param('confirmed'))
        if $cgi->param('confirmed') && $cgi->param('confirmed') !~ /^\d+$/;
    $confirmed = $1
        if $cgi->param('confirmed') && $cgi->param('confirmed') =~ /^(\d+)$/;

    die "invalid confirmation date" unless $confirmed;

    $did_order->confirmed($confirmed);
    $did_order->vendor_order_id($cgi->param('vendor_order_id'));
    $error = $did_order->replace;
    if ( $error ) {
        $cgi->param('error', $error);
        print $cgi->redirect(popurl(1). "did_order_confirm.html?". $cgi->query_string );
    }
}
elsif ( $action eq 'cancel' ) {
    my $sucess_msg = 'DID order cancelled';
    $error = $did_order->delete;
    $js = "window.location.href = '${p}browse/did_order.html'";
}
elsif ( $action eq 'provision' ) {
    my $sucess_msg = 'DID order provisioned';
    $cgi->param('pkgnum_svcpart') =~ /^(\d+)_(\d+)$/ or die 'illegal pkgnum_svcpart';
    my $pkgnum = $1;
    my $svcpart = $2;
    my @dids = qsearch( 'phone_avail', { ordernum => $ordernum } );
    die "no DIDs on order" unless scalar(@dids);
    foreach my $did ( @dids ) {
        my $svc_phone = new FS::svc_phone({
            pkgnum  => $pkgnum,
            svcpart => $svcpart,
            countrycode => 1,
            phonenum    => $did->npa.$did->nxx.$did->station,
        });
        $error = $svc_phone->insert;
        last if $error;
    }
}

</%init>

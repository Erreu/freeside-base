<% include( 'elements/browse.html',
                 'title'       => 'Bulk DID Orders',
                 'html_init'   => $html_init,
                 'name'        => 'bulk DID orders',
                 'disableable' => 0,
                 'query'       => { 'table'     => 'did_order',
				    'addl_from' => 'left join did_vendor using (vendornum) ',
                                    'hashref'   => {},
                                    'order_by' => 'ORDER BY ordernum',
                                  },
                 'count_query' => $count_query,
                 'header'      => $header,
                 'fields'      => $fields,
                 'links'       => [
				    [ $p.'edit/did_order.html?', 'ordernum' ],
				  ],
             )
%>
<%init>

die "access denied"
  unless $FS::CurrentUser::CurrentUser->access_right('Import');

my $conf = new FS::Conf;
my $date_format = $conf->config('date_format') || '%m/%d/%Y';

my $html_init = 
  qq!<A HREF="${p}edit/did_order.html"><I>Add a bulk DID order</I></A><BR><BR>!;

my $count_query = 'SELECT COUNT(*) FROM did_order';

my $display_date = sub {
    my $date = shift;
    return '' unless $date;
    time2str($date_format, $date);
};

my $header = [ '#', 'Vendor',' Vendor Order #', 'Submitted', 'Confirmed',
                'Customer', 'Received', ];
my $fields = [  sub {
		    my $did_order = shift;
		    $did_order->ordernum;
		}, 'vendorname', 'vendor_order_id', 
		sub { &$display_date(shift->submitted); }, 
		sub {
		    my $did_order = shift;
		    my $ordernum = $did_order->ordernum;
            return &$display_date($did_order->confirmed) if $did_order->confirmed;
            include( '/elements/popup_link.html',
              { 'action'      => "${p}misc/did_order_confirm.html?ordernum=$ordernum",
                'label'       => 'Confirm&nbsp;Bulk&nbsp;DID&nbsp;Order',
                'actionlabel' => 'Confirm Bulk DID Order',
                'width'       => 480,
                'height'      => 300,
              }
            )
        }, 
        sub {
            my $did_order = shift;
            my $cust_main = $did_order->cust_main;
            return "Stock" unless $cust_main;
            "<A HREF='${p}view/cust_main.cgi?".$cust_main->custnum."'>".$cust_main->name."</A>";
        },
		sub { 
		    my $did_order = shift;
		    my $ordernum = $did_order->ordernum;
		    return &$display_date($did_order->received) 
			    if $did_order->received;
		    "<A HREF='${p}misc/phone_avail-import.html?ordernum=$ordernum'>Upload Received</A>";
		}, 
	     ];

</%init>

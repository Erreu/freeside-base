<A NAME="cust_pkg"><FONT SIZE="+2">Packages</FONT></A>
% if ( $curuser->access_right('Order customer package') ) { 

  <% include('order_pkg.html', $cust_main ) %>
% } 
% if ( $curuser->access_right('One-time charge')
%        && $conf->config('payby-default') ne 'HIDE'
%      ) {
%

  <% include('/elements/popup_link.html',
     { 
       'action'      => $p. 'edit/quick-charge.html?custnum='. $cust_main->custnum,
       'label'       => 'One-time charge',
       'actionlabel' => 'One-time charge',
       'width'       => 545,
     })
  %>
  <BR>
% } 
% if ( $curuser->access_right('Bulk change customer packages') ) { 

  <A HREF="<% $p %>edit/cust_pkg.cgi?<% $cust_main->custnum %>">Bulk order and cancel packages</A> (preserves services)
% } 


<BR><BR>
% if ( @$packages ) { 

Current packages
% } 
% if ( $cust_main->num_cancelled_pkgs ) {
%     if ( $cgi->param('showcancelledpackages') eq '0' #see if it was set by me
%          || ( $conf->exists('hidecancelledpackages')
%               && ! $cgi->param('showcancelledpackages')
%             )
%        )
%     {
%       $cgi->param('showcancelledpackages', 1);
%

  ( <a href="<% $cgi->self_url %>">show
%   } else {
%       $cgi->param('showcancelledpackages', 0);
%

  ( <a href="<% $cgi->self_url %>">hide
%   } 

 cancelled packages</a> )
% } 
% if ( @$packages ) { 


<% include('/elements/table-grid.html') %>
% my $bgcolor1 = '#eeeeee';
%   my $bgcolor2 = '#ffffff';
%   my $bgcolor = '';

<TR>
  <TH CLASS="grid" BGCOLOR="#cccccc">Package</TH>
  <TH CLASS="grid" BGCOLOR="#cccccc">Status</TH>
  <TH CLASS="grid" BGCOLOR="#cccccc">Services</TH>
</TR>

%foreach my $cust_pkg (@$packages) {
%
%  my $part_pkg = $cust_pkg->part_pkg;
%
%  if ( $bgcolor eq $bgcolor1 ) {
%    $bgcolor = $bgcolor2;
%  } else {
%    $bgcolor = $bgcolor1;
%  }


<!--pkgnum: <% $cust_pkg->pkgnum %>-->
<TR>
  <TD CLASS="grid" BGCOLOR="<% $bgcolor %>">
    <A NAME="cust_pkg<% $cust_pkg->pkgnum %>"><% $cust_pkg->pkgnum %></A>:
    <% $part_pkg->pkg %> - <% $part_pkg->comment %>
    <BR>

%   if ( $cust_pkg->quantity > 1 ) {
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Quantity: <B><% $cust_pkg->quantity %></B><BR>
%   }

    <FONT SIZE=-1>
% unless ( $cust_pkg->get('cancel') ) { 
% if ( $curuser->access_right('Change customer package') ) { 

            (&nbsp;<%pkg_change_link($cust_pkg)%>&nbsp;)
% } 
% if ( $curuser->access_right('Edit customer package dates') ) { 

            (&nbsp;<%pkg_dates_link($cust_pkg)%>&nbsp;)
% } 
% if ( $curuser->access_right('Customize customer package') ) { 

            (&nbsp;<%pkg_customize_link($cust_pkg,$cust_main->custnum)%>&nbsp;)
% } 
% } 

    </FONT>
  </TD>
  <TD CLASS="inv" BGCOLOR="<% $bgcolor %>">
    <TABLE CLASS="inv" BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH="100%">
%
%  sub myfreq {
%    my $part_pkg = shift;
%    my $freq = $part_pkg->freq_pretty;
%    $freq =~ s/ /&nbsp;/g;
%    $freq;
%  }
%
%  #this should use cust_pkg->status and cust_pkg->statuscolor eventually
%  #my $colspan = $conf->exists('cust_pkg-display_times') ? 8 : 4;
%  #my $width = $conf->exists('cust_pkg-display_times') ? '38%' : '56%';
%
%  #false laziness w/edit/REAL_cust_pkg.cgi
%  my( $billed_or_prepaid, $last_bill_or_renewed, $next_bill_or_prepaid_until );
%  unless ( $part_pkg->is_prepaid ) {
%    $billed_or_prepaid = 'billed';
%    $last_bill_or_renewed = 'Last&nbsp;bill';
%    $next_bill_or_prepaid_until = 'Next&nbsp;bill';
%  } else {
%    $billed_or_prepaid = 'prepaid';
%    $last_bill_or_renewed = 'Renewed';
%    $next_bill_or_prepaid_until = 'Prepaid&nbsp;until';
%  }
%
%
% if ( $cust_pkg->get('cancel') ) { #status: cancelled
%   my $cpr = $cust_pkg->last_cust_pkg_reason;

    <% pkg_status_row($cust_pkg, 'Cancelled', 'cancel', 'color'=>'FF0000', conf=>$conf ) %>

    <% pkg_status_row_colspan(
         ( ( $cpr && ( $cpr->date == $cust_pkg->get('cancel') ||
                       $cpr->date == $cust_pkg->expire
                     )
           ) ? $cpr->reasontext. ' by '. $cpr->otaker : '' ), '',
         'align' => 'right', 'color' => 'ff0000', 'size' => '-2',
       )
    %>

%   unless ( $cust_pkg->get('setup') ) { 

        <% pkg_status_row_colspan('Never billed') %>

%   } else { 

       <% pkg_status_row( $cust_pkg, 'Setup', 'setup', conf=>$conf ) %>
       <% pkg_status_row_changed( $cust_pkg, conf=>$conf ) %>
       <% pkg_status_row_if( $cust_pkg, $last_bill_or_renewed, 'last_bill', conf=>$conf ) %>
       <% pkg_status_row_if( $cust_pkg, 'Suspended', 'susp', conf=>$conf ) %>

%   } 
%
% } else { 
%
%   if ( $cust_pkg->get('susp') ) { #status: suspended
%     my $cpr = $cust_pkg->last_cust_pkg_reason;

    <% pkg_status_row( $cust_pkg, 'Suspended', 'susp', 'color'=>'FF9900', conf=>$conf ) %>

    <% pkg_status_row_colspan(
         ( ( $cpr && ( $cpr->date == $cust_pkg->susp ||
                       $cpr->date == $cust_pkg->adjourn
                     )
           ) ? $cpr->reasontext. ' by '. $cpr->otaker : '' ), '',
         'align' => 'right', 'color' => 'FF9900', 'size' => '-2',
       )
    %>

%   unless ( $cust_pkg->get('setup') ) { 
      <% pkg_status_row_colspan('Never billed') %>
%   } else { 
      <% pkg_status_row($cust_pkg, 'Setup', 'setup', conf=>$conf ) %>
%   } 

    <% pkg_status_row_changed( $cust_pkg, conf=>$conf ) %>
    <% pkg_status_row_if( $cust_pkg, $last_bill_or_renewed, 'last_bill', conf=>$conf ) %>
%   # pkg_status_row($cust_pkg, 'Next bill', 'bill', conf=>$conf)
    <% pkg_status_row_if( $cust_pkg, 'Expires', 'expire', conf=>$conf ) %>

    <TR>
      <TD COLSPAN=<%$colspan%>>
        <FONT SIZE=-1>
%         if ( $curuser->access_right('Unsuspend customer package') ) { 
            (&nbsp;<% pkg_unsuspend_link($cust_pkg) %>&nbsp;)
%         } 
%         if ( $curuser->access_right('Cancel customer package immediately') ) {
            (&nbsp;<% pkg_cancel_link($cust_pkg) %>&nbsp;)
%         } 
        </FONT>
      </TD>
    </TR>

%   } else { #status: active
%
%     unless ( $cust_pkg->get('setup') ) { #not setup
%
%       unless ( $part_pkg->freq ) { 

          <% pkg_status_row_colspan('Not&nbsp;yet&nbsp;billed&nbsp;(one-time&nbsp;charge)') %>

          <TR>
            <TD COLSPAN=<%$colspan%>>
              <FONT SIZE=-1>
%               if ( $curuser->access_right('Cancel customer package immediately') ) { 
                  (&nbsp;<% pkg_cancel_link($cust_pkg) %>&nbsp;)
%               } 
              </FONT>
            </TD>
          </TR>

%       } else { 

         <% pkg_status_row_colspan("Not&nbsp;yet&nbsp;billed&nbsp;($billed_or_prepaid&nbsp;". myfreq($part_pkg). ')' ) %>

%       } 
%
%     } else { #setup
%
%       unless ( $part_pkg->freq ) { 

          <% pkg_status_row_colspan('One-time&nbsp;charge') %>

          <% pkg_status_row($cust_pkg, 'Billed', 'setup', conf=>$conf) %>

%       } else { 
%
%         if (scalar($cust_pkg->overlimit)) {

            <% pkg_status_row_colspan(
                 'Overlimit',
                 $billed_or_prepaid. '&nbsp;'. myfreq($part_pkg),
                 'color' => 'FFD000',
               )
            %>

%         } else {
            <% pkg_status_row_colspan(
                 'Active',
                 $billed_or_prepaid. '&nbsp;'. myfreq($part_pkg),
                 'color' => '00CC00',
               )
            %>
%         } 

          <% pkg_status_row($cust_pkg, 'Setup', 'setup', conf=>$conf) %>

%       } 
%
%     } 

      <% pkg_status_row_changed( $cust_pkg, conf=>$conf ) %>
      <% pkg_status_row_if( $cust_pkg, $last_bill_or_renewed, 'last_bill', conf=>$conf ) %>
      <% pkg_status_row_if( $cust_pkg, $next_bill_or_prepaid_until, 'bill', conf=>$conf ) %>
      <% pkg_status_row_if( $cust_pkg, 'Will suspend on', 'adjourn', conf=>$conf ) %>
      <% pkg_status_row_if( $cust_pkg, 'Expires', 'expire', conf=>$conf ) %>

%     if ( $part_pkg->freq ) { 

        <TR>
          <TD COLSPAN=<%$colspan%>>
            <FONT SIZE=-1>
%             if ( $curuser->access_right('Suspend customer package') ) { 
                (&nbsp;<% pkg_suspend_link($cust_pkg) %>&nbsp;)
%             } 
%             if ( $curuser->access_right('Suspend customer package later') ) { 
                (&nbsp;<% pkg_adjourn_link($cust_pkg) %>&nbsp;)
%             } 
%             if ( $curuser->access_right('Cancel customer package immediately') ) { 
                (&nbsp;<% pkg_cancel_link($cust_pkg) %>&nbsp;)
%             } 
%             if ( $curuser->access_right('Cancel customer package later') ) { 
                (&nbsp;<% pkg_expire_link($cust_pkg) %>&nbsp;)
%             } 

            <FONT>
          </TD>
        </TR>
%     }
%
%   } 
% } 

</TABLE>
</TD>

<TD CLASS="inv" BGCOLOR="<% $bgcolor %>">
  <TABLE CLASS="inv" BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH="100%">

%  #foreach my $svcpart (sort {$a->{svcpart} <=> $b->{svcpart}} @{$pkg->{svcparts}}) {
%  foreach my $part_svc ( $cust_pkg->part_svc ) {

%    #foreach my $service (@{$svcpart->{services}}) {
%    foreach my $cust_svc ( @{ $part_svc->cust_pkg_svc } ) {

      <TR>
        <TD ALIGN="right" VALIGN="top"><% FS::UI::Web::svc_link($m, $part_svc, $cust_svc) %></TD>
        <TD STYLE="padding-bottom:0px"><B><% FS::UI::Web::svc_label_link($m, $part_svc, $cust_svc) %></B></TD>
        <TD><% FS::UI::Web::svc_export_links($m, $part_svc, $cust_svc) %></TD>
      </TR>

      <TR>
        <TD ALIGN="right" COLSPAN="3" VALIGN="top" STYLE="padding-bottom:1px;padding-top:0px"><FONT SIZE="-2" COLOR="#FFD000">

            <% $cust_svc->overlimit ? "Overlimit: ". time2str('%b %o %Y' . ($conf->exists('cust_pkg-display_times') ? ' %l:%M %P' : ''), $cust_svc->overlimit) : '' %>
          </FONT></TD>
      </TR>

      <TR>
        <TD ALIGN="right" VALIGN="top" STYLE="padding-bottom:5px;padding-top:0px"><FONT SIZE="-2">

%         if ( $curuser->access_right('Recharge customer service')
%              && $part_svc->svcdb eq 'svc_acct'
%              && (    $cust_svc->svc_x->seconds    ne ''
%                   || $cust_svc->svc_x->upbytes    ne ''
%                   || $cust_svc->svc_x->downbytes  ne ''
%                   || $cust_svc->svc_x->totalbytes ne ''
%                 )
%         ) { 
            (&nbsp;<%svc_recharge_link($cust_svc)%>&nbsp;)
%         } 
          </FONT></TD>

          <TD ALIGN="right" VALIGN="top" STYLE="padding-bottom:5px;padding-top:0px"><FONT SIZE="-2">

%         if ( $curuser->access_right('Unprovision customer service') ) { 
            (&nbsp;<%svc_unprovision_link($cust_svc)%>&nbsp;)
%         } 
          </FONT></TD>
        </TR>
%   } 

%   if (    ! $cust_pkg->get('cancel')
%        && $curuser->access_right('Provision customer service') 
%        && $part_svc->num_avail
%      ) {

      <TR>
        <TD COLSPAN=3 ALIGN="center" STYLE="padding-bottom:4px;padding-top:0px">
          <B><% svc_provision_link($cust_pkg, $part_svc, $conf, $curuser) %></B>
        </TD>
      </TR>

%   } 

% } 

</TABLE>
</TD>
% } #end display packages
%


</TABLE>
% } else { 

<BR>
% } 
<%init>

my( $cust_main ) = @_;
my $conf = new FS::Conf;

my $curuser = $FS::CurrentUser::CurrentUser;

my $packages = get_packages($cust_main, $conf);

my $colspan = $conf->exists('cust_pkg-display_times') ? 8 : 4;
my $width = $conf->exists('cust_pkg-display_times') ? '38%' : '56%';

sub pkg_status_row {
  my( $cust_pkg, $title, $field, %opt ) = @_;

  my $color = $opt{'color'};

  my $html = qq(<TR><TD WIDTH="<%$width%>" ALIGN="right">);
  $html   .= qq(<FONT COLOR="#$color"><B>) if length($color);
  $html   .= qq($title&nbsp;);
  $html   .= qq(</B></FONT>) if length($color);
  $html   .= qq(</TD>);
  $html   .= pkg_datestr($cust_pkg, $field, $opt{conf}).'</TR>';

  $html;
}

sub pkg_status_row_if {
  my( $cust_pkg, $title, $field, %opt ) = @_;
  $cust_pkg->get($field) ? pkg_status_row(@_) : '';
}

sub pkg_status_row_changed {
  my( $cust_pkg, %opt ) = @_;
  return '' unless $cust_pkg->change_date;
  my $html = pkg_status_row( $cust_pkg, 'Package&nbsp;changed', 'change_date', conf=>$opt{'conf'} );
  my $old = $cust_pkg->old_cust_pkg;
  if ( $old ) {
    my $part_pkg = $old->part_pkg;
    my $label = 'Changed from '. $cust_pkg->change_pkgnum. ': '.
                $part_pkg->pkg. ' - '. $part_pkg->comment;
    $html .= pkg_status_row_colspan( $label, '', size=>'-1', align=>'right' );
  }
  $html;
}

sub pkg_status_row_colspan {
  my($title, $addl, %opt) = @_;

  my $align = $opt{'align'} ? 'ALIGN="'. $opt{'align'}.'"' : '';
  my $color = $opt{'color'} ? 'COLOR="#'.$opt{'color'}.'"' : '';
  my $size  = $opt{'size'}  ? 'SIZE="'.  $opt{'size'}. '"' : '';

  my $html = qq(<TR><TD COLSPAN=$colspan $align>);
  $html   .= qq(<FONT $color $size>) if length($color) || $size;
  $html   .= qq(<B>) if $color && !$size;
  $html   .= $title;
  $html   .= qq(</B>) if $color && !$size;
  $html   .= qq(</FONT>) if length($color) || $size;
  $html   .= ",&nbsp;$addl" if length($addl);
  $html   .= qq(</TD></TR>);

  $html;

}

#subroutines

sub get_packages {
  my $cust_main = shift or return undef;
  my $conf = shift;
  
  my @packages = ();
  my $method;
  if (  $cgi->param('showcancelledpackages') eq '0' #see if it was set by me
     || ( $conf->exists('hidecancelledpackages')
           && ! $cgi->param('showcancelledpackages') )
     )
  {
    $method = 'ncancelled_pkgs';
  } else {
    $method = 'all_pkgs';
  }

  [ $cust_main->$method() ];
}
  
sub svc_provision_link {
  my ($cust_pkg, $part_svc, $conf, $curuser) = @_;
  ( my $svc_nbsp = $part_svc->svc ) =~ s/\s+/&nbsp;/g;
  my $num_avail = $part_svc->num_avail;
  my $pkgnum_svcpart = "pkgnum=". $cust_pkg->pkgnum. ';'.
                       "svcpart=". $part_svc->svcpart;
  my $url;
  if ( $part_svc->svcdb eq 'svc_external' #could be generalized
       && $conf->exists('svc_external-skip_manual')
  ) {
    $url = "${p}edit/process/". $part_svc->svcdb. ".cgi?$pkgnum_svcpart";
  } else {
    $url = svc_url(
                    'm'        => $m,
                    'action'   => 'edit',
                    'part_svc' => $part_svc, 
                    'query'    => $pkgnum_svcpart,
                  );
    #$url = "${p}edit/$svcpart->{svcdb}.cgi?$pkgnum_svcpart";
  }

  my $link = qq!<A CLASS="provision" HREF="$url">!.
             "Provision&nbsp;$svc_nbsp&nbsp;($num_avail)</A>";
  if ( $conf->exists('legacy_link')
       && $curuser->access_right('View/link unlinked services')
     )
  {
    $link .= '<BR>'.
             qq!<A CLASS="provision" HREF="${p}misc/link.cgi?!.
             qq!$pkgnum_svcpart">!.
            "Link&nbsp;to&nbsp;legacy&nbsp;$svc_nbsp&nbsp;($num_avail)</A>";
  }
  $link;
}

sub svc_unprovision_link {
  my $cust_svc = shift or return '';
  qq!<A HREF="javascript:areyousure('${p}misc/unprovision.cgi?!. $cust_svc->svcnum.
  qq!', 'Permanently unprovision and delete this service?')">Unprovision</A>!;
}

sub pkg_datestr {
  my($cust_pkg, $field, $conf) = @_ or return '';
  return '&nbsp;' unless $cust_pkg->get($field);
  my $format = '<TD align="left"><B>%b</B></TD>'.
               '<TD align="right"><B>&nbsp;%o,</B></TD>'.
               '<TD align="right"><B>&nbsp;%Y</B></TD>';
  #$format .= '&nbsp;<FONT SIZE=-3>%l:%M:%S%P&nbsp;%z</FONT>'
  $format .= '<TD ALIGN="right"><B>&nbsp;%l</TD>'.
             '<TD ALIGN="center"><B>:</B></TD>'.
             '<TD ALIGN="left"><B>%M</B></TD>'.
             '<TD ALIGN="left"><B>&nbsp;%P</B></TD>'
    if $conf->exists('cust_pkg-display_times');
  my $strip = time2str($format, $cust_pkg->get($field) );
  $strip =~ s/ (\d)/$1/g;
  $strip;
}

sub pkg_change_link { include( '/elements/popup_link-cust_pkg.html',
                               { 'action'      => $p. 'misc/change_pkg.cgi?dummy=value',
                                 'label'       => 'Change&nbsp;package',
                                 'actionlabel' => 'Change',
                                 'cust_pkg'    => shift,
                               }
                             )
                     }

sub pkg_suspend_link { include( '/elements/popup_link-cust_pkg.html',
                                { 'action'      => $p. 'misc/cancel_pkg.html?method=suspend',
                                  'label'       => 'Suspend&nbsp;now',
                                  'actionlabel' => 'Suspend',
                                  'cust_pkg'    => shift,
                                }
                              )
                     }

sub pkg_unsuspend_link { pkg_link('misc/unsusp_pkg',    'Unsuspend',           @_ ); }
sub pkg_expire_link    { pkg_link('misc/expire_pkg',    'Cancel&nbsp;later',   @_ ); }
sub pkg_dates_link     { pkg_link('edit/REAL_cust_pkg', 'Edit&nbsp;dates',     @_ ); }

sub pkg_cancel_link { include( '/elements/popup_link-cust_pkg.html',
                               { 'action'      => $p. 'misc/cancel_pkg.html?method=cancel',
                                 'label'       => 'Cancel&nbsp;now',
                                 'actionlabel' => 'Cancel',
                                 'cust_pkg'    => shift,
                               }
                             )
                    }

sub pkg_adjourn_link { include( '/elements/popup_link-cust_pkg.html',
                                { 'action'      => $p. 'misc/cancel_pkg.html?method=adjourn',
                                  'label'       => 'Suspend&nbsp;later',
                                  'actionlabel' => 'Adjourn',
                                  'cust_pkg'    => shift,
                                }
                              )
                     }

sub pkg_expire_link { include( '/elements/popup_link-cust_pkg.html',
                               { 'action'      => $p. 'misc/cancel_pkg.html?method=expire',
                                 'label'       => 'Cancel&nbsp;later',
                                 'actionlabel' => 'Expire',
                                 'cust_pkg'    => shift,
                               }
                             )
                    }

sub svc_recharge_link { include( '/elements/popup_link-cust_svc.html',
                                 { 'action'      => $p. 'misc/recharge_svc.html',
                                   'label'       => 'Recharge',
                                   'actionlabel' => 'Recharge',
                                   'cust_svc'    => shift,
                                 }
                               )
                      }

sub pkg_link {
  my($action, $label, $cust_pkg) = @_;
  return '' unless $cust_pkg;
  qq!<a href="$p$action.cgi?!. $cust_pkg->pkgnum. qq!">$label</a>!;
}

sub pkg_customize_link {
  my $cust_pkg = shift or return '';
  my $custnum = $cust_pkg->custnum;
  qq!<A HREF="${p}edit/part_pkg.cgi?!.
    "keywords=$custnum;".
    "clone=". $cust_pkg->part_pkg->pkgpart. ';'.
    "pkgnum=". $cust_pkg->pkgnum.
    qq!">Customize</A>!;
}

</%init>

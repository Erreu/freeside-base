%# BEGIN LICENSE BLOCK
%# 
%# Copyright (c) 1996-2003 Jesse Vincent <jesse@bestpractical.com>
%# 
%# (Except where explictly superceded by other copyright notices)
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org.
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# Unless otherwise specified, all modifications, corrections or
%# extensions to this work which alter its source code become the
%# property of Best Practical Solutions, LLC when submitted for
%# inclusion in the work.
%# 
%# 
%# END LICENSE BLOCK
<& /Elements/Header, Title => loc("User view") &>

<& /Elements/ViewUser, User=>$u &>

<h2 class="title"><%loc("User view")%></h2>

%if ($session{CurrentUser} && ($session{CurrentUser}->Id == $id)) {
	<& /Elements/TitleBoxStart, title => loc('Signature')  &>
<form method=post>
<input type="hidden" name="id" value=<%$id%>>
<TEXTAREA COLS=72 ROWS=4 WRAP=HARD NAME="Signature"><% $u->Signature %></TEXTAREA><br><br>
<input type="submit" value="<&|/l&>Update signature</&>">
</form>
	  <& /Elements/TitleBoxEnd &>
	  <form method=post>
	  <&|/l&>Open tickets (from listing) in another window</&>: <input type="checkbox" name="NewWindowOption" <%exists $session{NewWindowOption} && "CHECKED"%>><br>
	  <&|/l&>Open tickets (from listing) in a new window</&>: <input type="checkbox" name="AlwaysNewWindowOption" <%exists $session{AlwaysNewWindowOption} && "CHECKED"%>><br>
	  <input type="submit" name="NewWindowSetting" value="<&|/l&>New window setting</&>">
	  </form>
%}

	<& /Elements/TitleBoxStart, title => loc('Email')  &>
<form method=post>
<input type="hidden" name="id" value="<%$id%>">
<input name="Email" value="<% $u->EmailAddress %>"><input type="submit" value="<&|/l&>Update email</&>">
</form>
	  <& /Elements/TitleBoxEnd &>
	<& /Elements/TitleBoxStart, title => loc('Real Name')  &>
<form method=post>
<input type="hidden" name="id" value="<%$id%>">
<input name="RealName" value="<% $u->RealName %>"><input type="submit" value="<&|/l&>Update name</&>">
</form>
	  <& /Elements/TitleBoxEnd &>

	<& /Elements/TitleBoxStart, title => loc('User ID')  &>
<form method=post>
<input type="hidden" name="id" value="<%$id%>">
<input name="Name" value="<% $u->Name %>"><input type="submit" value="<&|/l&>Update ID</&>">
</form>
	  <& /Elements/TitleBoxEnd &>

%# TODO: alternative email addresses + merging users

<%ARGS>
$id => $session{CurrentUser} ? $session{CurrentUser}->Id : 0
$Signature => undef
$Email => undef
$RealName => undef
$Name => undef
</%ARGS>

<%INIT>
require RT::User;
my $u=RT::User->new($session{CurrentUser});
$u->Load($id) || die loc("Couldn't load that user ([_1])", $id);
if ($Signature) {
my ($val, $msg)=$u->SetSignature($Signature);
$RT::Logger->log(level=>($val ? 'info' : 'error'), message=>$msg);
}

if ($Email) {
my ($val, $msg)=$u->SetEmailAddress($Email);
$RT::Logger->log(level=>($val ? 'info' : 'error'), message=>$msg);
}

if ($RealName) {
my ($val, $msg)=$u->SetRealName($RealName);
$RT::Logger->log(level=>($val ? 'info' : 'error'), message=>$msg);
}

if ($Name) {
my ($val, $msg)=$u->SetName($Name);
$RT::Logger->log(level=>($val ? 'info' : 'error'), message=>$msg);
}

if ($ARGS{NewWindowSetting}) {
if ($ARGS{NewWindowOption}) {
$session{NewWindowOption}=1;
} else {
delete $session{NewWindowOption};
}
if ($ARGS{AlwaysNewWindowOption}) {
$session{NewWindowOption}=1;
$session{AlwaysNewWindowOption}=1;
} else {
delete $session{AlwaysNewWindowOption};
}
}

</%INIT>









